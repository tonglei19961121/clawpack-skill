import chalk from 'chalk';
import { getConfig, saveConfig, scanLocalSkills } from '../config.js';
import { exec } from 'child_process';
import { promisify } from 'util';
const execAsync = promisify(exec);
async function detectGitHubToken() {
    // Priority 1: Environment variables
    const envToken = process.env.GITHUB_TOKEN || process.env.GH_TOKEN;
    if (envToken) {
        return { source: 'GITHUB_TOKEN env var', token: envToken };
    }
    // Priority 2: GitHub CLI
    try {
        const { stdout } = await execAsync('gh auth token', { timeout: 5000 });
        const token = stdout.trim();
        if (token) {
            return { source: 'GitHub CLI', token };
        }
    }
    catch {
        // GitHub CLI not installed or not logged in
    }
    return null;
}
export async function initCommand() {
    console.log(chalk.blue('ğŸš€ æ¬¢è¿ä½¿ç”¨ clawpackï¼\n'));
    console.log(chalk.gray('clawpack å¯ä»¥å¸®ä½ å¤‡ä»½å’Œæ¢å¤ AI å·¥å…·çš„æŠ€èƒ½é…ç½®\n'));
    const config = await getConfig();
    const isFirstTime = !config.githubToken;
    if (isFirstTime) {
        console.log(chalk.cyan('ğŸ”§ é¦–æ¬¡è®¾ç½®\n'));
    }
    // Step 1: GitHub Token
    console.log(chalk.cyan('1ï¸âƒ£  GitHub è®¤è¯'));
    const detected = await detectGitHubToken();
    if (detected) {
        const { source, token } = detected;
        console.log(chalk.green(`   âœ“ å·²æˆæƒ (${source})`));
        console.log(chalk.gray(`   Token: ${token.substring(0, 12)}...`));
        config.githubToken = token;
    }
    else {
        console.log(chalk.yellow('   âš   æœªæˆæƒ'));
        console.log(chalk.gray('   æ”¯æŒä»¥ä¸‹æ–¹å¼ï¼š'));
        console.log(chalk.gray('   1. export GITHUB_TOKEN=your_token'));
        console.log(chalk.gray('   2. gh auth login'));
        console.log(chalk.gray('   åˆ›å»º Token: https://github.com/settings/tokens'));
    }
    // Step 2: Scan existing skills
    console.log(chalk.cyan('\n2ï¸âƒ£  æ‰«æç°æœ‰æŠ€èƒ½'));
    const skills = await scanLocalSkills();
    if (skills.length > 0) {
        console.log(chalk.green(`   âœ“ æ‰¾åˆ° ${skills.length} ä¸ªæŠ€èƒ½ï¼š`));
        for (const skill of skills.slice(0, 5)) {
            console.log(chalk.gray(`     â€¢ ${skill.name}`));
        }
        if (skills.length > 5) {
            console.log(chalk.gray(`     ... è¿˜æœ‰ ${skills.length - 5} ä¸ª`));
        }
    }
    else {
        console.log(chalk.yellow('   âš   æœªå‘ç°æŠ€èƒ½'));
        console.log(chalk.gray('   ä½ å¯èƒ½éœ€è¦å…ˆå®‰è£…ä¸€äº› OpenClaw æŠ€èƒ½'));
    }
    await saveConfig(config);
    // Step 3: Suggest next steps
    console.log(chalk.cyan('\nğŸ“‹ å¸¸ç”¨å‘½ä»¤'));
    console.log(chalk.white('   åŸºç¡€å‘½ä»¤ï¼š'));
    console.log(chalk.gray('   clawpack list         æŸ¥çœ‹æ‰€æœ‰æŠ€èƒ½'));
    if (skills.length > 0 && config.githubToken) {
        console.log(chalk.white('\n   å¤‡ä»½æŠ€èƒ½ï¼š'));
        console.log(chalk.gray('   clawpack push         å¤‡ä»½æŠ€èƒ½ï¼ˆå¿«é€Ÿï¼‰'));
        console.log(chalk.gray('   clawpack backup       å®Œæ•´é…ç½®å¤‡ä»½ï¼ˆæ¨èï¼‰'));
        console.log(chalk.gray('   clawpack backup --full --workspace  åŒ…å«å·¥ä½œåŒºæ–‡ä»¶'));
    }
    if (config.defaultGistId) {
        console.log(chalk.white('\n   æ¢å¤é…ç½®ï¼š'));
        console.log(chalk.gray('   clawpack pull         æ¢å¤æŠ€èƒ½'));
        console.log(chalk.gray('   clawpack restore --full   æ¢å¤å®Œæ•´é…ç½®'));
    }
    console.log(chalk.green('\nâœ“ åˆå§‹åŒ–å®Œæˆï¼'));
    console.log(chalk.gray('\né…ç½®ä¿å­˜ä½ç½®ï¼š~/.config/clawpack/config.json'));
    // Smart suggestion
    if (skills.length > 0 && config.githubToken && !config.defaultGistId) {
        console.log(chalk.yellow('\nğŸ’¡ å»ºè®®ï¼š'));
        console.log(chalk.gray('   é¦–æ¬¡å¤‡ä»½æ¨èè¿è¡Œï¼šclawpack backup --full'));
        console.log(chalk.gray('   è¿™å°†å¤‡ä»½æŠ€èƒ½ + æ‰€æœ‰é…ç½® + å·¥ä½œåŒºæ–‡ä»¶'));
    }
}
