import chalk from 'chalk';
import { getConfig, saveConfig } from '../config.js';
import { createFullBackup, backupWorkspaceFiles } from '../backup.js';
import { createGist, updateGist, pushToRepo } from '../github.js';
export async function backupCommand(options) {
    const config = await getConfig();
    if (!config.githubToken) {
        console.log(chalk.red('âŒ GitHub Token æœªé…ç½®'));
        console.log(chalk.yellow('è¯·å…ˆè¿è¡Œï¼šclawpack init'));
        process.exit(1);
    }
    console.log(chalk.blue('ğŸ“¦ æ­£åœ¨åˆ›å»ºå¤‡ä»½...\n'));
    try {
        let manifest;
        if (options.full) {
            console.log(chalk.cyan('ğŸ”§ å®Œæ•´é…ç½®å¤‡ä»½æ¨¡å¼'));
            manifest = await createFullBackup(options.sensitive);
            console.log(chalk.green(`âœ“ å·²å¤‡ä»½é…ç½®ï¼š`));
            if (manifest.config.agents)
                console.log(chalk.gray('  â€¢ ä»£ç†é…ç½®'));
            if (manifest.config.channels)
                console.log(chalk.gray(`  â€¢ é€šé“é…ç½® (${Object.keys(manifest.config.channels).length} ä¸ª)`));
            if (manifest.config.plugins)
                console.log(chalk.gray('  â€¢ æ’ä»¶é…ç½®'));
            if (manifest.config.commands)
                console.log(chalk.gray('  â€¢ å‘½ä»¤è®¾ç½®'));
            if (manifest.config.hooks)
                console.log(chalk.gray('  â€¢ é’©å­é…ç½®'));
            if (!options.sensitive) {
                console.log(chalk.yellow('\nâš   æ•æ„Ÿä¿¡æ¯å·²æ’é™¤ï¼ˆä½¿ç”¨ --sensitive åŒ…å«ï¼‰'));
            }
        }
        else {
            // Skills-only backup (original behavior)
            const { scanLocalSkills } = await import('../config.js');
            const skills = await scanLocalSkills();
            manifest = {
                version: '2.0.0',
                exportedAt: new Date().toISOString(),
                platform: 'openclaw',
                type: 'skills-only',
                config: {},
                skills,
            };
            console.log(chalk.green(`âœ“ å·²å¤‡ä»½ ${skills.length} ä¸ªæŠ€èƒ½`));
        }
        // Backup workspace files if requested
        let workspaceFiles;
        if (options.workspace || options.full) {
            console.log(chalk.cyan('\nğŸ“ å¤‡ä»½å·¥ä½œåŒºæ–‡ä»¶...'));
            workspaceFiles = await backupWorkspaceFiles();
            const fileNames = Object.keys(workspaceFiles);
            if (fileNames.length > 0) {
                console.log(chalk.green(`âœ“ å·²å¤‡ä»½ ${fileNames.length} ä¸ªæ–‡ä»¶ï¼š`));
                for (const name of fileNames) {
                    console.log(chalk.gray(`  â€¢ ${name}`));
                }
            }
            else {
                console.log(chalk.yellow('âš   æœªå‘ç°å·¥ä½œåŒºæ–‡ä»¶'));
            }
        }
        // Upload to GitHub
        console.log(chalk.blue('\nğŸ“¤ ä¸Šä¼ åˆ° GitHub...'));
        const fullManifest = {
            ...manifest,
            _workspaceFiles: workspaceFiles,
        };
        let location;
        if (options.repo) {
            await pushToRepo(config.githubToken, options.repo, fullManifest);
            location = options.repo;
            console.log(chalk.green(`âœ“ å·²æ¨é€åˆ°ä»“åº“ï¼š${location}`));
        }
        else {
            if (config.defaultGistId) {
                await updateGist(config.githubToken, config.defaultGistId, fullManifest);
                location = config.defaultGistId;
                console.log(chalk.green(`âœ“ å·²æ›´æ–° Gistï¼š${location}`));
            }
            else {
                const gistId = await createGist(config.githubToken, fullManifest);
                config.defaultGistId = gistId;
                await saveConfig(config);
                location = gistId;
                console.log(chalk.green(`âœ“ å·²åˆ›å»º Gistï¼š${location}`));
            }
        }
        // Summary
        console.log(chalk.blue('\nğŸ“Š å¤‡ä»½æ‘˜è¦ï¼š'));
        console.log(chalk.green(`  ç±»å‹ï¼š${options.full ? 'å®Œæ•´é…ç½®' : 'ä»…æŠ€èƒ½'}`));
        console.log(chalk.green(`  æŠ€èƒ½ï¼š${manifest.skills.length} ä¸ª`));
        if (options.full) {
            const configSections = Object.keys(manifest.config).length;
            console.log(chalk.green(`  é…ç½®ï¼š${configSections} ä¸ªæ¨¡å—`));
        }
        if (workspaceFiles) {
            console.log(chalk.green(`  æ–‡ä»¶ï¼š${Object.keys(workspaceFiles).length} ä¸ª`));
        }
        console.log(chalk.yellow('\nğŸ’¡ æ¢å¤å‘½ä»¤ï¼š'));
        console.log(chalk.cyan(`  clawpack restore ${location}${options.full ? ' --full' : ''}`));
    }
    catch (error) {
        console.error(chalk.red('âŒ å¤‡ä»½å¤±è´¥ï¼š'), error instanceof Error ? error.message : error);
        process.exit(1);
    }
}
