import chalk from 'chalk';
import { getConfig, saveConfig, installSkill } from '../config.js';
import { getGist, getFromRepo } from '../github.js';
export async function pullCommand(source, options) {
    const config = await getConfig();
    if (!config.githubToken) {
        console.log(chalk.red('âŒ GitHub Token æœªé…ç½®'));
        console.log(chalk.yellow('è¯·å…ˆè¿è¡Œï¼šclawpack init'));
        process.exit(1);
    }
    // Auto-detect source if not provided
    if (!source) {
        if (config.defaultGistId) {
            console.log(chalk.blue(`ğŸ’¡ å‘ç°ä¹‹å‰çš„å¤‡ä»½ï¼š${config.defaultGistId}`));
            if (!options?.yes) {
                // Note: In real implementation, we'd use inquirer here
                // For now, we proceed automatically
                console.log(chalk.gray('   æ­£åœ¨æ¢å¤... (ä½¿ç”¨ --yes è‡ªåŠ¨ç¡®è®¤)'));
            }
            source = config.defaultGistId;
        }
        else {
            console.log(chalk.red('âŒ æœªæä¾›æ¢å¤æ¥æº'));
            console.log(chalk.yellow('è¯·æä¾› Gist ID æˆ–ä»“åº“ï¼š'));
            console.log(chalk.cyan('  clawpack pull <gist-id>'));
            console.log(chalk.cyan('  clawpack pull user/repo'));
            process.exit(1);
        }
    }
    console.log(chalk.blue(`ğŸ“¥ æ­£åœ¨ä» ${source} ä¸‹è½½...`));
    let manifest;
    try {
        if (source.includes('/')) {
            // Repo format: owner/repo
            manifest = await getFromRepo(config.githubToken, source);
        }
        else {
            // Gist ID
            manifest = await getGist(config.githubToken, source);
        }
    }
    catch (error) {
        console.error(chalk.red('âŒ ä¸‹è½½å¤±è´¥ï¼š'), error instanceof Error ? error.message : error);
        process.exit(1);
    }
    console.log(chalk.green(`âœ“ ä¸‹è½½æˆåŠŸï¼Œå…± ${manifest.skills.length} ä¸ªæŠ€èƒ½`));
    console.log(chalk.gray(`  å¹³å°ï¼š${manifest.platform}`));
    console.log(chalk.gray(`  å¤‡ä»½æ—¶é—´ï¼š${new Date(manifest.exportedAt).toLocaleString()}`));
    if (manifest.skills.length === 0) {
        console.log(chalk.yellow('\nâš  å¤‡ä»½ä¸­æ²¡æœ‰æŠ€èƒ½'));
        return;
    }
    // Show what will be installed
    console.log(chalk.blue('\nğŸ“‹ æŠ€èƒ½æ¸…å•ï¼š'));
    for (const skill of manifest.skills) {
        console.log(chalk.gray(`  â€¢ ${skill.name} (${skill.source})`));
    }
    // Install skills
    console.log(chalk.blue('\nğŸ“¦ å¼€å§‹å®‰è£…...\n'));
    const installed = [];
    const failed = [];
    const skipped = [];
    for (const skill of manifest.skills) {
        const name = skill.name;
        process.stdout.write(chalk.gray(`  å®‰è£… ${name}... `));
        try {
            await installSkill(name, skill.source);
            console.log(chalk.green('âœ“'));
            installed.push(name);
        }
        catch (error) {
            if (error.message?.includes('already installed') || error.message?.includes('already exists')) {
                console.log(chalk.yellow('å·²å®‰è£…'));
                skipped.push(name);
            }
            else {
                console.log(chalk.red('âœ—'));
                console.error(chalk.gray(`    ${error.message}`));
                failed.push(name);
            }
        }
    }
    // Summary
    console.log(chalk.blue('\nğŸ“Š å®‰è£…ç»“æœï¼š'));
    console.log(chalk.green(`  âœ“ æ–°å®‰è£…ï¼š${installed.length}`));
    if (skipped.length > 0) {
        console.log(chalk.yellow(`  âš  å·²å­˜åœ¨ï¼š${skipped.length}`));
    }
    if (failed.length > 0) {
        console.log(chalk.red(`  âœ— å¤±è´¥ï¼š${failed.length}`));
    }
    // Save as default for future pulls
    if (!source.includes('/')) {
        config.defaultGistId = source;
        await saveConfig(config);
    }
    // Smart next steps
    if (installed.length > 0) {
        console.log(chalk.yellow('\nğŸ’¡ æç¤ºï¼š'));
        console.log(chalk.cyan('  openclaw gateway restart    # é‡å¯ä»¥åŠ è½½æ–°æŠ€èƒ½'));
    }
    else if (skipped.length === manifest.skills.length) {
        console.log(chalk.green('\nâœ“ æ‰€æœ‰æŠ€èƒ½éƒ½å·²æ˜¯æœ€æ–°'));
    }
    if (failed.length > 0) {
        console.log(chalk.yellow('\nğŸ’¡ å¤±è´¥çš„æŠ€èƒ½å¯ä»¥æ‰‹åŠ¨å®‰è£…ï¼š'));
        for (const name of failed) {
            console.log(chalk.cyan(`  openclaw plugins install ${name}`));
        }
    }
}
