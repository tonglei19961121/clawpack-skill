import chalk from 'chalk';
import { readFile, mkdir, cp, rm } from 'fs/promises';
import { join } from 'path';
import { homedir } from 'os';
import { extract } from 'tar';
export async function unpackCommand(inputFile) {
    if (!inputFile) {
        console.log(chalk.red('âŒ è¯·æŒ‡å®šè¦è§£å‹çš„æ–‡ä»¶'));
        console.log(chalk.gray('   ä¾‹å¦‚ï¼šclawpack unpack clawpack-backup-123.zip'));
        process.exit(1);
    }
    if (!inputFile.endsWith('.zip') && !inputFile.endsWith('.tar.gz')) {
        console.log(chalk.red('âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼'));
        console.log(chalk.gray('   æ”¯æŒçš„æ ¼å¼ï¼š.zip, .tar.gz'));
        process.exit(1);
    }
    console.log(chalk.blue(`ğŸ“¦ æ­£åœ¨è§£å‹ ${inputFile}...\n`));
    const tempDir = join(homedir(), '.clawpack-temp', Date.now().toString());
    await mkdir(tempDir, { recursive: true });
    try {
        // Extract archive
        console.log(chalk.cyan('ğŸ“ è§£å‹å½’æ¡£...'));
        if (inputFile.endsWith('.zip')) {
            // For zip files, we'd need to use a different library
            // For now, let's use system unzip
            const { exec } = await import('child_process');
            const { promisify } = await import('util');
            const execAsync = promisify(exec);
            await execAsync(`unzip -q "${inputFile}" -d "${tempDir}"`);
        }
        else {
            await extract({
                file: inputFile,
                cwd: tempDir,
            });
        }
        // Read manifest
        console.log(chalk.cyan('ğŸ“‹ è¯»å–æ¸…å•...'));
        const manifestContent = await readFile(join(tempDir, 'manifest.json'), 'utf-8');
        const manifest = JSON.parse(manifestContent);
        console.log(chalk.green(`âœ“ å‘ç°å¤‡ä»½ï¼š${manifest.createdAt}`));
        console.log(chalk.gray(`   åŒ…å«ï¼š${manifest.contents.skills.length} ä¸ªæŠ€èƒ½`));
        console.log(chalk.gray(`   æ–‡ä»¶ï¼š${manifest.contents.workspaceFiles.length} ä¸ª`));
        // Confirm
        console.log(chalk.yellow('\nâš ï¸  è¿™å°†è¦†ç›–ä½ å½“å‰çš„ OpenClaw é…ç½®ï¼'));
        console.log(chalk.gray('   å»ºè®®åœ¨æ‰§è¡Œå‰å¤‡ä»½å½“å‰é…ç½®'));
        // Restore
        const openclawDir = join(homedir(), '.openclaw');
        const workspaceDir = join(openclawDir, 'workspace');
        const extensionsDir = join(openclawDir, 'extensions');
        // Restore config
        if (manifest.contents.config) {
            console.log(chalk.cyan('\nğŸ”§ æ¢å¤é…ç½®...'));
            const configPath = join(tempDir, 'config', 'openclaw.json');
            try {
                await readFile(configPath);
                await mkdir(openclawDir, { recursive: true });
                await cp(configPath, join(openclawDir, 'openclaw.json'), { force: true });
                console.log(chalk.green('âœ“ é…ç½®å·²æ¢å¤'));
            }
            catch {
                console.log(chalk.yellow('âš  é…ç½®æ¢å¤å¤±è´¥'));
            }
        }
        // Restore skills
        if (manifest.contents.skills.length > 0) {
            console.log(chalk.cyan('\nğŸ“¦ æ¢å¤æŠ€èƒ½...'));
            await mkdir(extensionsDir, { recursive: true });
            for (const skillName of manifest.contents.skills) {
                const skillSource = join(tempDir, 'skills', skillName);
                const skillTarget = join(extensionsDir, skillName);
                try {
                    await readFile(skillSource);
                    await cp(skillSource, skillTarget, { recursive: true, force: true });
                    console.log(chalk.gray(`  âœ“ ${skillName}`));
                }
                catch {
                    console.log(chalk.yellow(`  âš  ${skillName} (è·³è¿‡)`));
                }
            }
        }
        // Restore workspace files
        if (manifest.contents.workspaceFiles.length > 0) {
            console.log(chalk.cyan('\nğŸ“ æ¢å¤å·¥ä½œåŒºæ–‡ä»¶...'));
            await mkdir(workspaceDir, { recursive: true });
            for (const file of manifest.contents.workspaceFiles) {
                const fileSource = join(tempDir, 'workspace', file);
                const fileTarget = join(workspaceDir, file);
                try {
                    await cp(fileSource, fileTarget, { force: true });
                    console.log(chalk.gray(`  âœ“ ${file}`));
                }
                catch {
                    console.log(chalk.yellow(`  âš  ${file} (è·³è¿‡)`));
                }
            }
        }
        console.log(chalk.green('\nâœ“ æ¢å¤å®Œæˆï¼'));
        console.log(chalk.yellow('\nğŸ’¡ æç¤ºï¼š'));
        console.log(chalk.cyan('   openclaw gateway restart    # é‡å¯ä»¥ç”Ÿæ•ˆ'));
    }
    finally {
        // Cleanup temp dir
        await rm(tempDir, { recursive: true, force: true });
    }
}
