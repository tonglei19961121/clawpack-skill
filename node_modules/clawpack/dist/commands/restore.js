import chalk from 'chalk';
import { getConfig, saveConfig, installSkill } from '../config.js';
import { restoreFullBackup, restoreWorkspaceFiles, readOpenClawConfig } from '../backup.js';
import { getGist, getFromRepo } from '../github.js';
export async function restoreCommand(source, options) {
    const config = await getConfig();
    if (!config.githubToken) {
        console.log(chalk.red('âŒ GitHub Token æœªé…ç½®'));
        console.log(chalk.yellow('è¯·å…ˆè¿è¡Œï¼šclawpack init'));
        process.exit(1);
    }
    // Auto-detect source if not provided
    if (!source) {
        if (config.defaultGistId) {
            console.log(chalk.blue(`ğŸ’¡ å‘ç°ä¹‹å‰çš„å¤‡ä»½ï¼š${config.defaultGistId}`));
            source = config.defaultGistId;
        }
        else {
            console.log(chalk.red('âŒ æœªæä¾›æ¢å¤æ¥æº'));
            console.log(chalk.yellow('è¯·æä¾› Gist ID æˆ–ä»“åº“ï¼š'));
            console.log(chalk.cyan('  clawpack restore <gist-id>'));
            console.log(chalk.cyan('  clawpack restore user/repo'));
            process.exit(1);
        }
    }
    console.log(chalk.blue(`ğŸ“¥ æ­£åœ¨ä» ${source} ä¸‹è½½...`));
    let manifest;
    try {
        if (source.includes('/')) {
            manifest = await getFromRepo(config.githubToken, source);
        }
        else {
            manifest = await getGist(config.githubToken, source);
        }
    }
    catch (error) {
        console.error(chalk.red('âŒ ä¸‹è½½å¤±è´¥ï¼š'), error instanceof Error ? error.message : error);
        process.exit(1);
    }
    console.log(chalk.green(`âœ“ ä¸‹è½½æˆåŠŸ`));
    console.log(chalk.gray(`  å¤‡ä»½ç±»å‹ï¼š${manifest.type === 'full' ? 'å®Œæ•´é…ç½®' : 'ä»…æŠ€èƒ½'}`));
    console.log(chalk.gray(`  å¤‡ä»½æ—¶é—´ï¼š${new Date(manifest.exportedAt).toLocaleString()}`));
    // Save as default
    if (!source.includes('/')) {
        config.defaultGistId = source;
        await saveConfig(config);
    }
    const isFullBackup = options?.full || manifest.type === 'full';
    // Restore skills (always)
    if (manifest.skills?.length > 0) {
        console.log(chalk.blue(`\nğŸ“¦ æ¢å¤æŠ€èƒ½ (${manifest.skills.length} ä¸ª)...`));
        const installed = [];
        const skipped = [];
        const failed = [];
        for (const skill of manifest.skills) {
            process.stdout.write(chalk.gray(`  ${skill.name}... `));
            try {
                await installSkill(skill.name, skill.source);
                console.log(chalk.green('âœ“'));
                installed.push(skill.name);
            }
            catch (error) {
                if (error.message?.includes('already installed')) {
                    console.log(chalk.yellow('å·²å­˜åœ¨'));
                    skipped.push(skill.name);
                }
                else {
                    console.log(chalk.red('âœ—'));
                    failed.push(skill.name);
                }
            }
        }
        console.log(chalk.gray(`   æ–°å®‰è£…ï¼š${installed.length}ï¼Œå·²å­˜åœ¨ï¼š${skipped.length}ï¼Œå¤±è´¥ï¼š${failed.length}`));
    }
    // Restore configuration
    if (isFullBackup && manifest.config) {
        console.log(chalk.blue('\nğŸ”§ æ¢å¤é…ç½®...'));
        const currentConfig = await readOpenClawConfig();
        if (manifest.config.agents && !options?.skipAgents) {
            console.log(chalk.gray('  â€¢ ä»£ç†é…ç½®'));
        }
        if (manifest.config.channels && !options?.skipChannels) {
            const channelCount = Object.keys(manifest.config.channels).length;
            console.log(chalk.gray(`  â€¢ é€šé“é…ç½® (${channelCount} ä¸ª)`));
            console.log(chalk.yellow('    âš  æ³¨æ„ï¼šé€šé“é…ç½®åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨å¡«å†™ appSecret'));
        }
        if (manifest.config.plugins) {
            console.log(chalk.gray('  â€¢ æ’ä»¶é…ç½®'));
        }
        await restoreFullBackup(manifest, {
            merge: true,
            skipChannels: options?.skipChannels,
            skipAgents: options?.skipAgents,
        });
        console.log(chalk.green('âœ“ é…ç½®å·²æ¢å¤'));
    }
    // Restore workspace files
    const hasWorkspaceFiles = manifest._workspaceFiles && Object.keys(manifest._workspaceFiles).length > 0;
    if ((options?.workspace || isFullBackup) && hasWorkspaceFiles) {
        console.log(chalk.blue('\nğŸ“ æ¢å¤å·¥ä½œåŒºæ–‡ä»¶...'));
        const files = manifest._workspaceFiles;
        const fileNames = Object.keys(files);
        console.log(chalk.gray(`  å³å°†æ¢å¤ ${fileNames.length} ä¸ªæ–‡ä»¶ï¼š`));
        for (const name of fileNames) {
            console.log(chalk.gray(`    â€¢ ${name}`));
        }
        await restoreWorkspaceFiles(files);
        console.log(chalk.green('âœ“ å·¥ä½œåŒºæ–‡ä»¶å·²æ¢å¤'));
    }
    // Summary
    console.log(chalk.blue('\nğŸ“Š æ¢å¤å®Œæˆ'));
    console.log(chalk.yellow('\nğŸ’¡ æç¤ºï¼š'));
    if (manifest.skills?.length > 0) {
        console.log(chalk.cyan('  openclaw gateway restart    # é‡å¯ä»¥åŠ è½½æ–°æŠ€èƒ½'));
    }
    if (isFullBackup && manifest.config?.channels && !options?.skipChannels) {
        console.log(chalk.cyan('  openclaw config edit        # æ£€æŸ¥å¹¶å¡«å†™é€šé“å¯†é’¥'));
    }
    console.log(chalk.gray('\nä½ çš„ OpenClaw é…ç½®å·²åŒæ­¥å®Œæˆï¼'));
}
