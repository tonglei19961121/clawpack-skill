import chalk from 'chalk';
import { getConfig, saveConfig, scanLocalSkills } from '../config.js';
import { createGist, updateGist, pushToRepo } from '../github.js';
export async function pushCommand(options) {
    const config = await getConfig();
    if (!config.githubToken) {
        console.log(chalk.red('âŒ GitHub Token æœªé…ç½®'));
        console.log(chalk.yellow('è¯·å…ˆè¿è¡Œï¼šclawpack init'));
        console.log(chalk.gray('æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ï¼šexport GITHUB_TOKEN=ä½ çš„token'));
        process.exit(1);
    }
    console.log(chalk.blue('ğŸ“¦ æ­£åœ¨æ‰«ææœ¬åœ°æŠ€èƒ½...'));
    const skills = await scanLocalSkills();
    if (skills.length === 0) {
        console.log(chalk.yellow('âš   æœªå‘ç°æŠ€èƒ½'));
        console.log(chalk.gray('ä½ å¯èƒ½éœ€è¦å…ˆå®‰è£…ä¸€äº› OpenClaw æŠ€èƒ½'));
        console.log(chalk.gray('ä¾‹å¦‚ï¼šopenclaw plugins install @openclaw/github'));
        return;
    }
    console.log(chalk.green(`âœ“ å‘ç° ${skills.length} ä¸ªæŠ€èƒ½`));
    console.log(chalk.gray('  å³å°†å¤‡ä»½ï¼š'));
    for (const skill of skills.slice(0, 5)) {
        console.log(chalk.gray(`    â€¢ ${skill.name}`));
    }
    if (skills.length > 5) {
        console.log(chalk.gray(`    ... è¿˜æœ‰ ${skills.length - 5} ä¸ª`));
    }
    const manifest = {
        version: '1.0.0',
        exportedAt: new Date().toISOString(),
        platform: 'openclaw',
        skills,
    };
    try {
        if (options.repo) {
            // Push to repository
            console.log(chalk.blue(`\nğŸ“¤ æ¨é€åˆ°ä»“åº“ ${options.repo}...`));
            await pushToRepo(config.githubToken, options.repo, manifest);
            console.log(chalk.green(`âœ“ æ¨é€æˆåŠŸï¼`));
            console.log(chalk.gray(`  ä»“åº“ï¼š${options.repo}`));
        }
        else {
            // Use Gist by default
            if (config.defaultGistId) {
                console.log(chalk.blue('\nğŸ“¤ æ›´æ–°å·²æœ‰ Gist...'));
                await updateGist(config.githubToken, config.defaultGistId, manifest);
                console.log(chalk.green('âœ“ æ›´æ–°æˆåŠŸï¼'));
                console.log(chalk.gray(`  Gist IDï¼š${config.defaultGistId}`));
            }
            else {
                console.log(chalk.blue('\nğŸ“¤ åˆ›å»ºæ–° Gist...'));
                const gistId = await createGist(config.githubToken, manifest);
                config.defaultGistId = gistId;
                await saveConfig(config);
                console.log(chalk.green('âœ“ åˆ›å»ºæˆåŠŸï¼'));
                console.log(chalk.cyan(`  Gist IDï¼š${gistId}`));
            }
        }
        // Summary and next steps
        console.log(chalk.blue('\nğŸ“Š å¤‡ä»½æ‘˜è¦ï¼š'));
        console.log(chalk.green(`  âœ“ æŠ€èƒ½æ•°é‡ï¼š${skills.length}`));
        console.log(chalk.gray(`  âœ“ å¤‡ä»½æ—¶é—´ï¼š${new Date().toLocaleString()}`));
        if (!options.repo) {
            console.log(chalk.yellow('\nğŸ’¡ åœ¨å…¶ä»–è®¾å¤‡æ¢å¤ï¼š'));
            console.log(chalk.cyan(`  clawpack pull ${config.defaultGistId}`));
            if (!config.defaultGistId) {
                console.log(chalk.gray('   æˆ–ç›´æ¥è¿è¡Œï¼šclawpack pullï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰'));
            }
        }
    }
    catch (error) {
        console.error(chalk.red('âŒ å¤‡ä»½å¤±è´¥ï¼š'), error instanceof Error ? error.message : error);
        console.log(chalk.gray('\nå¯èƒ½çš„åŸå› ï¼š'));
        console.log(chalk.gray('  â€¢ GitHub Token æƒé™ä¸è¶³ï¼ˆéœ€è¦ gist æƒé™ï¼‰'));
        console.log(chalk.gray('  â€¢ ç½‘ç»œè¿æ¥é—®é¢˜'));
        console.log(chalk.gray('  â€¢ GitHub API é™åˆ¶'));
        process.exit(1);
    }
}
