import chalk from 'chalk';
import { createWriteStream } from 'fs';
import { readdir, stat } from 'fs/promises';
import { join } from 'path';
import { homedir } from 'os';
import archiver from 'archiver';
import { scanLocalSkills } from '../config.js';
export async function packCommand(outputFile) {
    const output = outputFile || `clawpack-backup-${Date.now()}.zip`;
    console.log(chalk.blue('ğŸ“¦ æ­£åœ¨æ‰“åŒ… OpenClaw é…ç½®...\n'));
    // Scan what we have
    const skills = await scanLocalSkills();
    const openclawDir = join(homedir(), '.openclaw');
    const workspaceDir = join(openclawDir, 'workspace');
    console.log(chalk.cyan('ğŸ” æ‰«æå†…å®¹ï¼š'));
    // Check main config
    let hasConfig = false;
    try {
        await stat(join(openclawDir, 'openclaw.json'));
        hasConfig = true;
        console.log(chalk.gray('  âœ“ ä¸»é…ç½®æ–‡ä»¶'));
    }
    catch {
        console.log(chalk.yellow('  âš  æœªæ‰¾åˆ°ä¸»é…ç½®æ–‡ä»¶'));
    }
    // Check skills
    console.log(chalk.gray(`  âœ“ ${skills.length} ä¸ªæŠ€èƒ½`));
    // Check workspace files
    const workspaceFiles = [];
    try {
        const files = await readdir(workspaceDir);
        for (const file of files) {
            if (file.endsWith('.md')) {
                workspaceFiles.push(file);
            }
        }
        console.log(chalk.gray(`  âœ“ ${workspaceFiles.length} ä¸ªå·¥ä½œåŒºæ–‡ä»¶`));
    }
    catch {
        console.log(chalk.gray('  â„¹ æ— å·¥ä½œåŒºæ–‡ä»¶'));
    }
    // Create archive
    console.log(chalk.cyan('\nğŸ“ åˆ›å»ºå½’æ¡£...'));
    const outputStream = createWriteStream(output);
    const archive = archiver('zip', { zlib: { level: 9 } });
    archive.on('error', (err) => {
        throw err;
    });
    archive.pipe(outputStream);
    // Add manifest
    const manifest = {
        version: '1.0',
        createdAt: new Date().toISOString(),
        platform: 'openclaw',
        clawpackVersion: '1.2.3',
        contents: {
            config: hasConfig,
            skills: skills.map(s => s.name),
            workspaceFiles,
        },
    };
    archive.append(JSON.stringify(manifest, null, 2), { name: 'manifest.json' });
    // Add main config
    if (hasConfig) {
        archive.file(join(openclawDir, 'openclaw.json'), { name: 'config/openclaw.json' });
    }
    // Add skills (extensions)
    const extensionsDir = join(openclawDir, 'extensions');
    for (const skill of skills) {
        const skillDir = join(extensionsDir, skill.name);
        try {
            await stat(skillDir);
            archive.directory(skillDir, `skills/${skill.name}`);
        }
        catch {
            // Skill not in extensions dir (might be built-in)
        }
    }
    // Add workspace files
    for (const file of workspaceFiles) {
        archive.file(join(workspaceDir, file), { name: `workspace/${file}` });
    }
    await archive.finalize();
    // Wait for stream to finish
    await new Promise((resolve, reject) => {
        outputStream.on('close', () => resolve());
        outputStream.on('error', reject);
    });
    // Get file size
    const stats = await stat(output);
    const sizeMB = (stats.size / 1024 / 1024).toFixed(2);
    console.log(chalk.green(`\nâœ“ æ‰“åŒ…å®Œæˆï¼`));
    console.log(chalk.cyan(`ğŸ“„ æ–‡ä»¶ï¼š${output}`));
    console.log(chalk.gray(`   å¤§å°ï¼š${sizeMB} MB`));
    console.log(chalk.gray(`   å†…å®¹ï¼š${skills.length} ä¸ªæŠ€èƒ½ + ${workspaceFiles.length} ä¸ªæ–‡ä»¶`));
    console.log(chalk.yellow('\nğŸ’¡ å¦‚ä½•ä½¿ç”¨ï¼š'));
    console.log(chalk.gray('   1. å°†æ–‡ä»¶å¤åˆ¶åˆ°æ–°è®¾å¤‡'));
    console.log(chalk.gray(`   2. è¿è¡Œï¼šclawpack unpack ${output}`));
    console.log(chalk.gray('   3. å®Œæˆï¼æ— éœ€ GitHub è´¦å·'));
}
